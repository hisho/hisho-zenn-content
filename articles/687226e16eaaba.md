---
title: "firebase v9ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å¤‰æ›´"
emoji: "ğŸ¯"
type: "tech"
topics: ["firebase","typescript"]
published: true
---
v9ç³»ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å¤‰æ›´ã«è©°ã¾ã£ãŸã®ã§è¨˜äº‹ã«ã™ã‚‹

## ç’°å¢ƒ
- firebase v9.x
  - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼
- react-hook-form v7.x
- zod v3.x
- chakra v1.x

## è©²å½“éƒ¨åˆ†
#### ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´
https://firebase.google.com/docs/auth/web/manage-users?hl=ja#set_a_users_password
#### ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å¤‰æ›´
https://firebase.google.com/docs/auth/web/manage-users?hl=ja#set_a_users_email_address
#### ãƒ¦ãƒ¼ã‚¶ãƒ¼å†èªè¨¼
https://firebase.google.com/docs/auth/web/manage-users?hl=ja#re-authenticate_a_user

å…¬å¼ãŒä¸å¯§ã ã£ãŸã‚Šçªãæ”¾ã•ã‚ŒãŸã‚Šã™ã‚‹ã®ã§ã¤ã‚‰ã„

## ä½•ãŒå•é¡Œãªã®ã‹
> ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®å‰Šé™¤ã€ãƒ¡ã‚¤ãƒ³ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®è¨­å®šã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å¤‰æ›´ã¨ã„ã£ãŸã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šé‡è¦ãªæ“ä½œã‚’è¡Œã†ã«ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæœ€è¿‘ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

> é‡è¦: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¨­å®šã™ã‚‹ã«ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæœ€è¿‘ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å†èªè¨¼ã‚’ã”è¦§ãã ã•ã„ã€‚

> é‡è¦: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã™ã‚‹ã«ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæœ€è¿‘ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å†èªè¨¼ã‚’ã”è¦§ãã ã•ã„ã€‚

<br />
ï¼ï¼Ÿ<br />
ã¤ã¾ã‚Šãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å¤‰æ›´ã™ã‚‹ã«ã¯ã¾ãšå†èªè¨¼ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‚‰ã—ã„
```ts:re-authenticate_a_user
import { getAuth, reauthenticateWithCredential } from "firebase/auth";

const auth = getAuth();
const user = auth.currentUser;

// TODO(you): prompt the user to re-provide their sign-in credentials
const credential = promptForCredentials();

reauthenticateWithCredential(user, credential).then(() => {
  // User re-authenticated.
}).catch((error) => {
  // An error ocurred
  // ...
});
```
<br />
ï¼ï¼Ÿ<br />
TODOã«æ›¸ã„ã¦ã‚ã‚‹`promptForCredentials()`ãŒçªå¦‚å‘¼ã°ã‚Œã¦`credential`ã‚’ã©ã“ã‹ã‚‰å–å¾—ã™ã‚Œã°ã„ã„ã®ã‹ã‚ã‹ã‚‰ãªã„ğŸ˜‚


## reauthenticateWithCredentialã«æŠ•ã’ã‚‹credentialã‚’å–å¾—ã™ã‚‹

https://stackoverflow.com/questions/37811684/how-to-create-credential-object-needed-by-firebase-web-user-reauthenticatewith
stackoverflowã«v9ã§EmailAuthProviderã‹ã‚‰credentialã‚’å–å¾—ã™ã‚‹è¨˜äº‹ã‚’ç™ºè¦‹ğŸ˜
```ts
const credential = EmailAuthProvider.credential(
    auth.currentUser.email,
    userProvidedPassword
)
```

ã¤ã¾ã‚Šä¸‹è¨˜ã®æ§‹é€ ã«ã—ã¦ãã®å¾Œå‡¦ç†ã‚’ã•ã›ã‚Œã°è‰¯ã•ãã†
1. ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—ã™ã‚‹`(getAuth().currentUser)`
2. ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—ã—ã‚»ãƒƒãƒˆã™ã‚‹`(user?.email ?? '')`
3. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯å…¥åŠ›ã—ã¦ã‚‚ã‚‰ã†`(password)`
4. credentialã‚’å–å¾—ã™ã‚‹`(EmailAuthProvider.credential)`
5. 1ã¨4ã§å–å¾—ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨credentialã‚’ä½¿ç”¨ã—å†èªè¨¼ã•ã›ã‚‹`(reauthenticateWithCredential)`

```ts
import { FirebaseError } from '@firebase/util'
import {
  EmailAuthProvider,
  getAuth,
  reauthenticateWithCredential,
} from 'firebase/auth'

(async () => {
  const user = getAuth().currentUser
  try {
    const credential = await EmailAuthProvider.credential(
      user?.email ?? '', 
      password
    )
    user && (await reauthenticateWithCredential(user, credential))
    //ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã®å‡¦ç†
  } catch (e) {
    if (e instanceof FirebaseError) {
      console.error(e)
    }
  }
})()
```

ã¨ã„ã†ã“ã¨ã§

## formã¨ã‚³ã‚¢ãªéƒ¨åˆ†ã ã‘å®Ÿè£…ã™ã‚‹

### ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´
```ts
import { FirebaseError } from '@firebase/util'
import { zodResolver } from '@hookform/resolvers/zod'
import {
  EmailAuthProvider,
  getAuth,
  reauthenticateWithCredential,
  updateEmail,
} from 'firebase/auth'
import { useForm } from 'react-hook-form'
import { z } from 'zod'

/**
 * ç°¡æ˜“ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
 */
const schema = z.object({
  newEmail: z.string().email(),
  password: z.string().min(6),
})

type UpdateEmailInput = z.infer<typeof schema>

/**
 * @see https://firebase.google.com/docs/auth/web/manage-users?hl=ja#set_a_users_email_address
 * @see https://firebase.google.com/docs/auth/web/manage-users?hl=ja#re-authenticate_a_user
 * @see https://stackoverflow.com/questions/37811684/how-to-create-credential-object-needed-by-firebase-web-user-reauthenticatewith
 * firebaseã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å¤‰æ›´ã‚’ã™ã‚‹é–¢æ•°
 * æˆåŠŸ
 * 1. EmailAuthProvider.credential(firebaseã«ãƒ­ã‚°ã‚¤ãƒ³ã•ã›credentialã‚’å–å¾—ã™ã‚‹)
 * 2. reauthenticateWithCredential(credentialã‚’ä½¿ã„firebaseã‚’å†èªè¨¼ã•ã›ã‚‹)
 * 3. updateEmail(ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å†è¨­å®šã™ã‚‹)
 * å¤±æ•—
 * 1. firebaseã®ã‚¨ãƒ©ãƒ¼ã‚’åã
 */
export const useUpdateEmail = () => {
  const form = useForm<UpdateEmailInput>({
    defaultValues: {
      newEmail: '',
      password: '',
    },
    resolver: zodResolver(schema),
  })

  const onUpdateEmail = form.handleSubmit(async ({ newEmail, password }) => {
    const user = getAuth().currentUser
    try {
      const credential = await EmailAuthProvider.credential(
        user?.email ?? '',
        password
      )
      user && (await reauthenticateWithCredential(user, credential))
      user && (await updateEmail(user, newEmail))
      form.setValue('newEmail', '')
      form.setValue('password', '')
    } catch (e) {
      form.setValue('password', '')
      if (e instanceof FirebaseError) {
        console.error(e)
      }
    }
  })
  return {
    form,
    onUpdateEmail,
  }
}
```
```tsx
const UpdatePassword = () => {
  const {
    form: { register },
    onUpdatePassword,
  } = useUpdatePassword()

  return (
    <Box borderWidth={1} p={4}>
      <Heading size={'md'}>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</Heading>
      <FormControl>
        <Input placeholder={'ä»Šã®PW'} {...register('password')} />
      </FormControl>
      <FormControl >
        <Input placeholder={'æ–°ã—ã„PW'} {...register('newPassword')} />
      </FormControl>
      <FormControl >
        <Input placeholder={'æ–°ã—ã„PWç¢ºèª'} {...register('newPasswordConfirm')} />
      </FormControl>
      <Button onClick={onUpdatePassword}>
        ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´
      </Button>
    </Box>
  )
}
```

### ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å¤‰æ›´
```ts
import { FirebaseError } from '@firebase/util'
import { zodResolver } from '@hookform/resolvers/zod'
import {
  EmailAuthProvider,
  getAuth,
  reauthenticateWithCredential,
  updatePassword,
} from 'firebase/auth'
import { useForm } from 'react-hook-form'
import { z } from 'zod'

/**
 * ç°¡æ˜“ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
 */
const schema = z
  .object({
    newPassword: z.string().min(6),
    newPasswordConfirm: z.string().min(6),
    password: z.string().min(6),
  })
  .refine((data) => data.newPassword === data.newPasswordConfirm, {
    message: "Passwords don't match",
    path: ['newPasswordConfirm'],
  })

type UpdatePasswordInput = z.infer<typeof schema>

/**
 * @see https://firebase.google.com/docs/auth/web/manage-users?hl=ja#set_a_users_password
 * @see https://firebase.google.com/docs/auth/web/manage-users?hl=ja#re-authenticate_a_user
 * @see https://stackoverflow.com/questions/37811684/how-to-create-credential-object-needed-by-firebase-web-user-reauthenticatewith
 * firebaseã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã‚’ã™ã‚‹é–¢æ•°
 * æˆåŠŸ
 * 1. EmailAuthProvider.credential(firebaseã«ãƒ­ã‚°ã‚¤ãƒ³ã•ã›credentialã‚’å–å¾—ã™ã‚‹)
 * 2. reauthenticateWithCredential(credentialã‚’ä½¿ã„firebaseã‚’å†èªè¨¼ã•ã›ã‚‹)
 * 3. updatePassword(ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å†è¨­å®šã™ã‚‹)
 * å¤±æ•—
 * 1. firebaseã®ã‚¨ãƒ©ãƒ¼ã‚’åã
 */
export const useUpdatePassword = () => {
  const form = useForm<UpdatePasswordInput>({
    defaultValues: {
      newPassword: '',
      newPasswordConfirm: '',
      password: '',
    },
    resolver: zodResolver(schema),
  })

  const onUpdatePassword = form.handleSubmit(
    async ({ newPassword, password }) => {
      const user = getAuth().currentUser
      try {
        const credential = await EmailAuthProvider.credential(
          user?.email ?? '',
          password
        )
        user && (await reauthenticateWithCredential(user, credential))
        user && (await updatePassword(user, newPassword))
      } catch (e) {
        if (e instanceof FirebaseError) {
          console.error(e)
        }
      } finally {
        form.setValue('password', '')
        form.setValue('newPassword', '')
        form.setValue('newPasswordConfirm', '')
      }
    }
  )
  return {
    form,
    onUpdatePassword,
  }
}
```

```tsx
const UpdateEmail = () => {
  const {
    form: { register },
    onUpdateEmail,
  } = useUpdateEmail()
  return (
    <Box borderWidth={1} p={4}>
      <Heading size={'md'}>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å¤‰æ›´</Heading>
      <FormControl>
        <Input placeholder={'ä»Šã®PW'} {...register('password')} />
      </FormControl>
      <FormControl>
        <Input placeholder={'æ–°ã—ã„ãƒ¡ã‚¢ãƒ‰'} type={'email'} {...register('newEmail')} />
      </FormControl>
      <Button onClick={onUpdateEmail}>
        ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å¤‰æ›´
      </Button>
    </Box>
  )
}
```

## æœ€å¾Œã«
validationã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã€loadingãªã©ã‚’ãŠå¿˜ã‚Œãªãï¼ï¼

## ãŠã¾ã‘

### ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ
```ts
import { FirebaseError } from '@firebase/util'
import { zodResolver } from '@hookform/resolvers/zod'
import { getAuth, sendPasswordResetEmail } from 'firebase/auth'
import { useForm } from 'react-hook-form'
import { z } from 'zod'

/**
 * ç°¡æ˜“ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
 */
const schema = z.object({
  email: z.string().email(),
})

type SendPasswordResetEmailInput = z.infer<typeof schema>


/**
 * @see https://firebase.google.com/docs/auth/web/manage-users?hl=ja#send_a_password_reset_email
 * firebaseã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã‚’ã™ã‚‹é–¢æ•°
 * æˆåŠŸ
 * 1. æŒ‡å®šã—ãŸãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡
 * å¤±æ•—
 * 1. firebaseã®ã‚¨ãƒ©ãƒ¼ã‚’åã
 */
export const useSendPasswordResetEmail = () => {
  const form = useForm<SendPasswordResetEmailInput>({
    defaultValues: {
      email: '',
    },
    resolver: zodResolver(schema),
  })

  const onSendPasswordResetEmail = form.handleSubmit(async ({ email }) => {
    try {
      await sendPasswordResetEmail(getAuth(), email)
      form.setValue('email', '')
    } catch (e) {
      if (e instanceof FirebaseError) {
        console.error(e)
      }
    }
  })
  return {
    form,
    onSendPasswordResetEmail,
  }
}
```
```tsx
const SendPasswordResetEmail = () => {
  const {
    form: { register },
    onSendPasswordResetEmail,
  } = useSendPasswordResetEmail()
  return (
    <Box borderWidth={1} p={4}>
      <Heading size={'md'}>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ</Heading>
      <FormControl>
        <Input placeholder={'ãƒªã‚»ãƒƒãƒˆã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ã‚¢ãƒ‰'} {...register('email')} />
      </FormControl>
      <Button onClick={onSendPasswordResetEmail}>
        ãƒªã‚»ãƒƒãƒˆ
      </Button>
    </Box>
  )
}
```